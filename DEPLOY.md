
Инструкция как настраивать deploy для Шипита
===========================================

Папка куда разворачивается проект
deployTo: '/имя_папки',

Малопонятная временная папка, которую можно создать только в /tmp боевого сервера. Почему - пока не ясно.
workspace: '/tmp/имя_папки/github-monitor',

Путь к приватному ключу на сервере разработки
key: '/home/ubuntu/.ssh/id_rsa',

Создание ключей
1) Ключи создаются на сервере разработки (внимание, не на боевом!)
2) Инструкцию создания ключей аналогична как для гитхаба
3) Публичный ключ, который создается вместе с приватным, нужно скопировать в файл ~/.ssh/authorized_keys на боевом сервере.
здесь ~ домашняя папка того пользователя, под которым мы заходим с сервера разработки при помощи шипита на боевой.

Здесь указываем логин того пользователя, для которого копировали публичный ключ
servers: 'username@141.8.194.121'


Ссылки по теме:
-----------------

https://www.npmjs.com/package/shipit-pm2
http://pm2.keymetrics.io/docs/usage/deployment/
http://pm2.keymetrics.io/docs/tutorials/capistrano-like-deployments
https://github.com/shipitjs/shipit-deploy
https://github.com/shipitjs/shipit

https://github.com/mattanglin/shipit-pm2-nginx

Настройка сервера перед первым деплоем
--------------------------------------

Пользователю, через которого производится деплой, нужно дать право не вводить пароль для команды sudo pm2.
Для этого в файле /etc/sudoers следует настроить привилегии для данного пользователя следующим образом:
<логин пользователя> ALL=(ALL) NOPASSWD: /usr/bin/pm2, /usr/bin/npm

Если команда pm2 находится по другому пути, то этот путь можно узнать при помощи команды:
`which pm2`

Запуск pm2 через sudo требуется, чтобы у пользователя была возможность создавать слушателя на порту 80.


Ускорение деплоя
--------------

Зависимости ставятся командой `npm install --link --production`
Поэтому можно предварительно в систему глобально установить модули, которые используют все релизы приложения.
В этом случае локально в релизах будут ставиться ссылки на глобальные модули. 
Это быстрее и экономичнее по занимаемому пространству на диске.


Проблемы:
----------

1) Для любого пользователя не root запрещено занимать порт 80.
В итоге невозможно запустить сервер на этом порту, если деплой запускать от обычного пользователя.

Решение:

Слушатель на 80-ом порту требует повышенных привилегий пользователя, поэтому запускаем программу (в частности PM2) через sudo.
Для повышения привилегий в файле /etc/sudoers делается правка:
<логин пользователя> ALL=(ALL) NOPASSWD: /usr/bin/pm2
Чтобы sudo не запрашивал пароль.
Так как pm2 запускается с повышенными правами, то не забывать его всегда запускать с sudo (например, `sudo pm2 logs`).
Источник: https://toster.ru/q/341598?e=4184542#comment_1147428

Надо выяснить, если возможность разрешить sudo только для команды pm2? (http://white55.ru/sudo.html)